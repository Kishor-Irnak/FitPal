<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Gym Tracker</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- 3. Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- 4. Custom Styles -->
    <style>
      body {
        font-family: "Inter", sans-serif;
        min-height: 100dvh;
        background-color: #0c0c0c; /* Deep dark background */
        color: #f1f5f9;
      }

      /* Hide number input spinners */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
      }

      /* Custom Neon Colors */
      .bg-neon {
        background-color: #afff0c;
      }
      .text-neon {
        color: #afff0c;
      }
      .border-neon {
        border-color: #afff0c;
      }
      .ring-neon {
        --tw-ring-color: #afff0c;
      }

      /* Custom Card Style */
      .card {
        background-color: #1a1a1a;
        border-radius: 1rem; /* 16px */
      }

      /* Custom Input Style */
      .input-field {
        background-color: #2a2a2a;
        border: 1px solid #3f3f46; /* zinc-700 */
        color: white;
        border-radius: 0.5rem; /* 8px */
        padding: 0.75rem 1rem; /* 12px 16px */
        width: 100%;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .input-field:focus {
        outline: none;
        border-color: #afff0c;
        box-shadow: 0 0 0 2px rgba(175, 255, 12, 0.5);
      }

      /* Custom Button Style */
      .btn {
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        font-weight: 600;
        text-align: center;
        transition: all 0.2s;
      }
      .btn-neon {
        background-color: #afff0c;
        color: #0c0c0c;
      }
      .btn-neon:hover {
        background-color: #98e00a;
      }
      .btn-gray {
        background-color: #2a2a2a;
        color: white;
      }
      .btn-gray:hover {
        background-color: #3f3f46;
      }
      .btn-red {
        background-color: #ef4444; /* red-500 */
        color: white;
      }
      .btn-red:hover {
        background-color: #dc2626; /* red-600 */
      }

      /* Custom Scrollbar */
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #2a2a2a;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #afff0c;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #8bcc0a;
      }

      /* Fade-in for new sets */
      .animate-fade-in {
        animation: fadeIn 0.3s ease-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Message Box (Toast) */
      #message-box {
        position: fixed;
        bottom: 5rem; /* Above nav bar */
        left: 50%;
        transform: translateX(-50%) translateY(20px) scale(0.95);
        opacity: 0;
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        z-index: 100;
        pointer-events: none;
      }
      #message-box.show {
        transform: translateX(-50%) translateY(0) scale(1);
        opacity: 1;
      }
    </style>
  </head>

  <body class="bg-[#0C0C0C]">
    <!-- Main App Container -->
    <!-- Added pb-24 to avoid overlap with fixed bottom nav -->
    <!-- Set max-width for better desktop viewing, centered with mx-auto -->
    <div class="min-h-screen pb-24 p-4 max-w-lg mx-auto">
      <!-- =================================================================== -->
      <!-- VIEW 1: Routines (Home) -->
      <!-- =================================================================== -->
      <div id="routinesView" class="space-y-6 view">
        <header>
          <h1 id="welcome-message" class="text-3xl font-bold text-white">
            Hi, User!
          </h1>
          <p class="text-gray-400">Let's track your progress.</p>
        </header>

        <!-- Form to add a new routine -->
        <form id="add-routine-form" class="card p-4 space-y-3">
          <input
            type="text"
            id="new-routine-name"
            class="input-field"
            placeholder="e.g., Push Day"
            required
          />
          <button type="submit" class="btn btn-neon w-full">
            Add New Routine
          </button>
        </form>

        <!-- List of routines -->
        <div id="routine-list" class="space-y-3">
          <!-- Routines will be dynamically injected here -->
        </div>
      </div>

      <!-- =================================================================== -->
      <!-- VIEW 2: Body Weight -->
      <!-- =================================================================== -->
      <div id="bodyWeightView" class="space-y-6 view hidden">
        <header>
          <h1 class="text-3xl font-bold text-white">Body Weight</h1>
        </header>

        <!-- Form to add bodyweight -->
        <form id="add-bodyweight-form" class="card p-4 space-y-3">
          <label
            for="bodyweight-input"
            class="block text-sm font-medium text-gray-400"
            >Log Today's Weight</label
          >
          <div class="flex items-center space-x-3">
            <input
              type="number"
              id="bodyweight-input"
              inputmode="decimal"
              step="0.01"
              class="input-field w-1/2 text-center"
              placeholder="75.5"
              required
            />
            <span
              id="bodyweight-unit"
              class="text-lg font-semibold text-gray-300"
              >kg</span
            >
            <button type="submit" class="btn btn-neon flex-1">Log</button>
          </div>
        </form>

        <!-- Body Weight Chart -->
        <section class="card p-4">
          <h3 class="text-lg font-semibold text-white mb-3">Weight Progress</h3>
          <div class="h-64">
            <canvas id="bodyweight-chart"></canvas>
          </div>
        </section>

        <!-- Body Weight History List -->
        <section>
          <h3 class="text-lg font-semibold text-white mb-3">Weight History</h3>
          <div
            id="bodyweight-history"
            class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar pr-2"
          >
            <!-- Body weight entries here -->
          </div>
        </section>
      </div>

      <!-- =================================================================== -->
      <!-- VIEW 3: Global History -->
      <!-- =================================================================== -->
      <div id="globalHistoryView" class="space-y-6 view hidden">
        <header>
          <h1 class="text-3xl font-bold text-white">Global History</h1>
        </header>

        <!-- Total Volume Chart -->
        <section class="card p-4">
          <h3 class="text-lg font-semibold text-white mb-3">
            Total Volume (kg)
          </h3>
          <p class="text-sm text-gray-400 mb-3 -mt-2">
            Total weight lifted (reps * weight) per day.
          </p>
          <div class="h-64">
            <canvas id="totalVolumeChart"></canvas>
          </div>
        </section>

        <!-- All Workout History List -->
        <section>
          <h3 class="text-lg font-semibold text-white mb-3">All Workouts</h3>
          <div id="global-workout-history-list" class="space-y-4">
            <!-- Global workout history here -->
          </div>
        </section>
      </div>

      <!-- =================================================================== -->
      <!-- VIEW 4: Profile (Settings) -->
      <!-- =================================================================== -->
      <div id="profileView" class="space-y-6 view hidden">
        <header class="flex items-center space-x-4">
          <img
            id="profile-avatar"
            src="https://placehold.co/64x64/AFF0C/0C0C0C?text=U"
            alt="User Avatar"
            class="w-16 h-16 rounded-full border-2 border-neon"
          />
          <div>
            <h1 id="profile-name" class="text-3xl font-bold text-white">
              User
            </h1>
            <p class="text-gray-400">Settings & Data</p>
          </div>
        </header>

        <!-- Change Name Section -->
        <section class="card p-4 space-y-3">
          <label
            for="username-input"
            class="block text-sm font-medium text-gray-400"
            >Your Name</label
          >
          <form id="update-name-form" class="flex items-center space-x-3">
            <input type="text" id="username-input" class="input-field" />
            <button type="submit" class="btn btn-neon">Save</button>
          </form>
        </section>

        <!-- Units Section -->
        <section class="card p-4 space-y-4">
          <div class="flex items-center justify-between">
            <label class="text-lg font-medium text-white">Units</label>
            <div class="flex items-center p-1 bg-[#2A2A2A] rounded-full">
              <button
                id="unit-toggle-kg"
                class="px-4 py-1 text-sm font-semibold rounded-full"
                data-unit="kg"
              >
                kg
              </button>
              <button
                id="unit-toggle-lbs"
                class="px-4 py-1 text-sm font-semibold rounded-full"
                data-unit="lbs"
              >
                lbs
              </button>
            </div>
          </div>
        </section>

        <!-- Data Management Section -->
        <section class="card p-4">
          <h3 class="text-lg font-semibold text-white mb-2">Data Management</h3>
          <p class="text-sm text-gray-400 mb-4">
            This will delete all routines, exercises, and history. This action
            cannot be undone.
          </p>
          <button id="clear-all-btn" class="btn btn-red w-full">
            Clear All Data
          </button>
        </section>
      </div>

      <!-- =================================================================== -->
      <!-- SUB-VIEW 5: Routine Detail -->
      <!-- =================================================================== -->
      <div id="routineDetailView" class="space-y-6 view hidden">
        <header class="flex items-center justify-between">
          <button id="routine-detail-back-btn" class="p-2 -ml-2 text-neon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <h1
            id="current-routine-name"
            class="text-2xl font-bold text-white text-center truncate"
          >
            Routine Name
          </h1>
          <button id="delete-routine-btn" class="p-2 -mr-2 text-red-500">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="3 6 5 6 21 6"></polyline>
              <path
                d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
              ></path>
            </svg>
          </button>
        </header>

        <!-- Form to add a new exercise to this routine -->
        <form id="add-exercise-to-routine-form" class="card p-4 space-y-3">
          <input
            type="text"
            id="new-routine-exercise-name"
            class="input-field"
            placeholder="e.g., Barbell Bench Press"
            required
          />
          <button type="submit" class="btn btn-neon w-full">
            Add Exercise
          </button>
        </form>

        <h3 class="text-xl font-semibold text-white">Exercises</h3>
        <div id="routine-exercise-list" class="space-y-3">
          <!-- Exercises for the current routine -->
        </div>
      </div>

      <!-- =================================================================== -->
      <!-- SUB-VIEW 6: Exercise Logging -->
      <!-- =================================================================== -->
      <div id="exerciseLoggingView" class="space-y-6 view hidden">
        <header class="flex items-center justify-between">
          <button id="exercise-logging-back-btn" class="p-2 -ml-2 text-neon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <h1
            id="logging-exercise-name"
            class="text-2xl font-bold text-white text-center truncate"
          >
            Exercise Name
          </h1>
          <button
            id="delete-exercise-from-routine-btn"
            class="p-2 -mr-2 text-red-500"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="3 6 5 6 21 6"></polyline>
              <path
                d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
              ></path>
            </svg>
          </button>
        </header>

        <!-- Progressive Overload Info Box -->
        <div class="card p-4 text-center">
          <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wide">
            Last Workout
          </h3>
          <p
            id="last-workout-info"
            class="text-lg font-semibold text-neon mt-1"
          >
            No previous history.
          </p>
          <button
            id="show-exercise-history-btn"
            class="mt-2 text-sm font-medium text-gray-300 hover:underline"
          >
            View All History
          </button>
        </div>

        <!-- Form to log a new set -->
        <form id="add-set-form" class="card p-4 space-y-4">
          <div class="flex gap-4">
            <div class="flex-1">
              <label
                for="reps-input"
                class="block text-sm font-medium text-gray-400 mb-1"
                >Reps</label
              >
              <input
                type="number"
                id="reps-input"
                inputmode="numeric"
                class="input-field text-lg text-center"
                placeholder="8"
              />
            </div>
            <div class="flex-1">
              <label
                for="weight-input"
                class="block text-sm font-medium text-gray-400 mb-1"
              >
                Weight (<span id="current-weight-unit">kg</span>)
              </label>
              <input
                type="number"
                id="weight-input"
                inputmode="decimal"
                step="0.5"
                class="input-field text-lg text-center"
                placeholder="100"
              />
            </div>
          </div>
          <button type="submit" class="btn btn-neon w-full">Add Set</button>
        </form>

        <h3 class="text-xl font-semibold text-white">Today's Sets</h3>
        <ul id="current-sets-list" class="space-y-2 min-h-[50px]">
          <!-- Today's sets here -->
        </ul>

        <!-- Save Workout Button -->
        <div class="pt-4">
          <button id="save-workout-btn" class="btn btn-gray w-full text-lg">
            Save Workout
          </button>
        </div>
      </div>

      <!-- =================================================================== -->
      <!-- SUB-VIEW 7: Exercise History (Specific) -->
      <!-- =================================================================== -->
      <div id="exerciseHistoryView" class="space-y-6 view hidden">
        <header class="flex items-center justify-between">
          <button id="exercise-history-back-btn" class="p-2 -ml-2 text-neon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <h1
            id="history-exercise-name"
            class="text-2xl font-bold text-white text-center truncate"
          >
            Exercise History
          </h1>
          <div class="w-10"></div>
          <!-- Spacer -->
        </header>

        <div id="full-exercise-history-list" class="space-y-4">
          <!-- Full history for the selected exercise -->
        </div>
      </div>
    </div>
    <!-- End Main App Container -->

    <!-- =================================================================== -->
    <!-- Welcome Modal (NEW) -->
    <!-- =================================================================== -->
    <div
      id="welcome-modal"
      class="fixed inset-0 z-50 items-center justify-center hidden bg-black bg-opacity-90 p-4"
    >
      <div
        class="card p-6 shadow-lg w-full max-w-sm border border-gray-700 text-center"
      >
        <h2 class="text-2xl font-bold text-white mb-3">Welcome to FitPal!</h2>
        <p class="text-gray-300 mb-6">What should we call you?</p>
        <form id="welcome-form" class="space-y-4">
          <input
            type="text"
            id="name-input"
            class="input-field text-center text-lg"
            placeholder="Enter your name"
            required
          />
          <button type="submit" class="btn btn-neon w-full">Get Started</button>
        </form>
      </div>
    </div>

    <!-- =================================================================== -->
    <!-- Confirmation Modal -->
    <!-- =================================================================== -->
    <div
      id="confirmation-modal"
      class="fixed inset-0 z-50 items-center justify-center hidden bg-black bg-opacity-75 p-4"
    >
      <div class="card p-6 shadow-lg w-full max-w-sm border border-gray-700">
        <h2 id="modal-title" class="text-xl font-bold text-white mb-4">
          Are you sure?
        </h2>
        <p id="modal-message" class="text-gray-300 mb-6">
          This action cannot be undone.
        </p>
        <div class="flex justify-end space-x-4">
          <button id="modal-cancel-btn" class="btn btn-gray">Cancel</button>
          <button id="modal-confirm-btn" class="btn btn-red">Confirm</button>
        </div>
      </div>
    </div>

    <!-- =================================================================== -->
    <!-- Message Box (Toast Notification) -->
    <!-- =================================================================== -->
    <div id="message-box" class="py-3 px-5 rounded-lg shadow-lg">
      <span id="message-text" class="font-semibold">Workout Saved!</span>
    </div>

    <!-- =================================================================== -->
    <!-- Bottom Navigation Bar (4-Tab) -->
    <!-- =================================================================== -->
    <!-- Set max-width for better desktop viewing, centered with mx-auto -->
    <nav
      class="fixed bottom-0 left-0 right-0 z-40 flex items-center justify-around h-20 bg-[#1A1A1A] border-t border-gray-700 max-w-lg mx-auto"
    >
      <!-- Routines (Home) -->
      <button
        class="flex flex-col items-center p-2 text-neon nav-btn"
        data-view="routinesView"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span class="text-xs font-medium">Routines</span>
      </button>

      <!-- Body Weight -->
      <button
        class="flex flex-col items-center p-2 text-gray-400 nav-btn"
        data-view="bodyWeightView"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <!-- Simple scale icon -->
          <path d="M3 6l6-4 6 4 6-4v16l-6 4-6-4-6 4V6z"></path>
          <line x1="12" y1="2" x2="12" y2="22"></line>
        </svg>
        <span class="text-xs font-medium">Weight</span>
      </button>

      <!-- Global History -->
      <button
        class="flex flex-col items-center p-2 text-gray-400 nav-btn"
        data-view="globalHistoryView"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M3 3v18h18"></path>
          <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"></path>
        </svg>
        <span class="text-xs font-medium">History</span>
      </button>

      <!-- Profile -->
      <button
        class="flex flex-col items-center p-2 text-gray-400 nav-btn"
        data-view="profileView"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span class="text-xs font-medium">Profile</span>
      </button>
    </nav>

    <!-- =================================================================== -->
    <!-- JAVASCRIPT (MERGED & FUNCTIONAL) -->
    <!-- =================================================================== -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- STATE & CONSTANTS ---
        let db = {}; // The 'database'
        let currentView = "routinesView";
        let currentRoutine = null;
        let currentExerciseInRoutine = null;
        let currentSets = []; // Sets for the exercise being logged
        let modalConfirmCallback = null;
        let unitPreference = "kg";
        let userName = ""; // NEW state for user's name
        let activeCharts = {}; // To hold Chart.js instances
        const KG_TO_LBS = 2.20462;
        const LBS_TO_KG = 0.453592;

        // --- CHART.JS DEFAULTS ---
        const neonColor = "#afff0c";
        const gridColor = "rgba(255, 255, 255, 0.1)";
        const textColor = "#f1f5f9";
        Chart.defaults.color = textColor;
        Chart.defaults.borderColor = gridColor;

        // --- DOM ELEMENTS ---
        // Views
        const views = {
          routinesView: document.getElementById("routinesView"),
          bodyWeightView: document.getElementById("bodyWeightView"),
          globalHistoryView: document.getElementById("globalHistoryView"),
          profileView: document.getElementById("profileView"),
          routineDetailView: document.getElementById("routineDetailView"),
          exerciseLoggingView: document.getElementById("exerciseLoggingView"),
          exerciseHistoryView: document.getElementById("exerciseHistoryView"),
        };
        const navButtons = document.querySelectorAll(".nav-btn");

        // Welcome Modal (NEW)
        const welcomeModal = document.getElementById("welcome-modal");
        const welcomeForm = document.getElementById("welcome-form");
        const nameInput = document.getElementById("name-input");
        const welcomeMessage = document.getElementById("welcome-message");

        // Profile View
        const unitToggleKg = document.getElementById("unit-toggle-kg");
        const unitToggleLbs = document.getElementById("unit-toggle-lbs");
        const clearAllBtn = document.getElementById("clear-all-btn");
        const profileAvatar = document.getElementById("profile-avatar"); // NEW
        const profileName = document.getElementById("profile-name"); // NEW
        const updateNameForm = document.getElementById("update-name-form"); // NEW
        const usernameInput = document.getElementById("username-input"); // NEW

        // Routines View
        const addRoutineForm = document.getElementById("add-routine-form");
        const newRoutineInput = document.getElementById("new-routine-name");
        const routineList = document.getElementById("routine-list");

        // Body Weight View
        const addBodyweightForm = document.getElementById(
          "add-bodyweight-form"
        );
        const bodyweightInput = document.getElementById("bodyweight-input");
        const bodyweightUnitSpan = document.getElementById("bodyweight-unit");
        const bodyweightHistoryList =
          document.getElementById("bodyweight-history");
        const bodyweightChartCanvas = document
          .getElementById("bodyweight-chart")
          .getContext("2d");

        // Global History View
        const globalWorkoutHistoryList = document.getElementById(
          "global-workout-history-list"
        );
        const totalVolumeChartCanvas = document
          .getElementById("totalVolumeChart")
          .getContext("2d");

        // Routine Detail View
        const routineDetailBackBtn = document.getElementById(
          "routine-detail-back-btn"
        );
        const deleteRoutineBtn = document.getElementById("delete-routine-btn");
        const currentRoutineName = document.getElementById(
          "current-routine-name"
        );
        const addExerciseToRoutineForm = document.getElementById(
          "add-exercise-to-routine-form"
        );
        const newRoutineExerciseName = document.getElementById(
          "new-routine-exercise-name"
        );
        const routineExerciseList = document.getElementById(
          "routine-exercise-list"
        );

        // Exercise Logging View
        const exerciseLoggingBackBtn = document.getElementById(
          "exercise-logging-back-btn"
        );
        const deleteExerciseFromRoutineBtn = document.getElementById(
          "delete-exercise-from-routine-btn"
        );
        const loggingExerciseName = document.getElementById(
          "logging-exercise-name"
        );
        const lastWorkoutInfo = document.getElementById("last-workout-info");
        const showExerciseHistoryBtn = document.getElementById(
          "show-exercise-history-btn"
        );
        const addSetForm = document.getElementById("add-set-form");
        const repsInput = document.getElementById("reps-input");
        const weightInput = document.getElementById("weight-input");
        const currentWeightUnitSpan = document.getElementById(
          "current-weight-unit"
        );
        const currentSetsList = document.getElementById("current-sets-list");
        const saveWorkoutBtn = document.getElementById("save-workout-btn");

        // Exercise History View
        const exerciseHistoryBackBtn = document.getElementById(
          "exercise-history-back-btn"
        );
        const historyExerciseName = document.getElementById(
          "history-exercise-name"
        );
        const fullExerciseHistoryList = document.getElementById(
          "full-exercise-history-list"
        );

        // Modal & Message
        const modal = document.getElementById("confirmation-modal");
        const modalTitle = document.getElementById("modal-title");
        const modalMessage = document.getElementById("modal-message");
        const modalCancelBtn = document.getElementById("modal-cancel-btn");
        const modalConfirmBtn = document.getElementById("modal-confirm-btn");
        const messageBox = document.getElementById("message-box");
        const messageText = document.getElementById("message-text");

        // --- DATA FUNCTIONS ---
        function loadData() {
          const data = localStorage.getItem("fitPalData");
          db = data ? JSON.parse(data) : { routines: {}, bodyWeight: [] };
          unitPreference = localStorage.getItem("unitPreference") || "kg";
          userName = localStorage.getItem("userName") || ""; // NEW
        }

        function saveData() {
          localStorage.setItem("fitPalData", JSON.stringify(db));
          localStorage.setItem("unitPreference", unitPreference);
          localStorage.setItem("userName", userName); // NEW
        }

        // --- NAME FUNCTIONS (NEW) ---
        function updateUserNameDisplay() {
          const name = userName || "User";
          const initial = name.charAt(0).toUpperCase() || "U";
          welcomeMessage.textContent = `Hi, ${name}!`;
          profileName.textContent = name;
          usernameInput.value = name;
          profileAvatar.src = `https://placehold.co/64x64/AFF0C/0C0C0C?text=${initial}`;
          profileAvatar.alt = `${name}'s avatar`;
        }

        // --- UNIT CONVERSION ---
        function convertWeight(value, fromUnit, toUnit) {
          if (fromUnit === toUnit || !value) return value;
          if (fromUnit === "lbs" && toUnit === "kg") return value * LBS_TO_KG;
          if (fromUnit === "kg" && toUnit === "lbs") return value * KG_TO_LBS;
          return value;
        }

        function formatWeight(kgValue, displayUnit = unitPreference) {
          let displayValue = kgValue;
          if (displayUnit === "lbs") {
            displayValue = convertWeight(kgValue, "kg", "lbs");
          }
          const precision = displayUnit === "lbs" ? 1 : 2;
          const formattedValue = parseFloat(displayValue.toFixed(precision));
          return `${Number(formattedValue.toFixed(precision))} ${displayUnit}`;
        }

        function updateUnitPreference(unit) {
          unitPreference = unit;
          unitToggleKg.classList.toggle("bg-neon", unit === "kg");
          unitToggleKg.classList.toggle("text-black", unit === "kg");
          unitToggleKg.classList.toggle("text-white", unit !== "kg");

          unitToggleLbs.classList.toggle("bg-neon", unit === "lbs");
          unitToggleLbs.classList.toggle("text-black", unit === "lbs");
          unitToggleLbs.classList.toggle("text-white", unit !== "lbs");

          bodyweightUnitSpan.textContent = unit;
          currentWeightUnitSpan.textContent = unit;

          saveData();

          if (currentView === "exerciseLoggingView") {
            renderCurrentSets();
            lastWorkoutInfo.textContent = formatLastWorkout(
              currentRoutine,
              currentExerciseInRoutine
            );
          }
          if (currentView === "bodyWeightView") {
            renderBodyWeightHistory();
          }
          if (currentView === "globalHistoryView") {
            renderGlobalHistory();
          }
          if (currentView === "exerciseHistoryView") {
            renderExerciseHistory(currentRoutine, currentExerciseInRoutine);
          }
        }

        // --- UTILITY FUNCTIONS ---
        function toTitleCase(str) {
          if (!str) return "";
          return str.replace(
            /\w\S*/g,
            (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
          );
        }
        function getTodayDate() {
          return new Date().toISOString().split("T")[0];
        }
        function formatDateDisplay(isoDate) {
          const date = new Date(isoDate);
          return date.toLocaleDateString(undefined, {
            year: "numeric",
            month: "short",
            day: "numeric",
            timeZone: "UTC",
          });
        }

        function formatLastWorkout(routineName, exerciseName) {
          if (
            !db.routines[routineName] ||
            !db.routines[routineName][exerciseName]
          ) {
            return "No previous history. Go for it!";
          }
          const history = db.routines[routineName][exerciseName];
          if (history.length === 0) {
            return "No previous history. Go for it!";
          }

          const lastWorkout = history[history.length - 1];
          const sets = lastWorkout.sets;
          if (sets.length === 0) {
            return `No sets logged on ${formatDateDisplay(lastWorkout.date)}`;
          }

          const lastSet = sets[sets.length - 1];
          const lastWeightFormatted = formatWeight(lastSet.weight);
          return `${sets.length} sets on ${formatDateDisplay(
            lastWorkout.date
          )}. Last: ${lastSet.reps} reps @ ${lastWeightFormatted}`;
        }

        // --- MODAL & MESSAGE FUNCTIONS ---
        function showModal(title, message, onConfirm) {
          modalTitle.textContent = title;
          modalMessage.textContent = message;
          modalConfirmCallback = onConfirm;
          modal.classList.remove("hidden");
          modal.classList.add("flex");
        }

        function hideModal() {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
          modalConfirmCallback = null;
        }

        function showMessage(message, isError = false) {
          messageText.textContent = message;
          messageBox.classList.toggle("bg-red-500", isError);
          messageBox.classList.toggle("text-white", isError);
          messageBox.classList.toggle("bg-neon", !isError);
          messageBox.classList.toggle("text-black", !isError);

          messageBox.classList.add("show");
          setTimeout(() => {
            messageBox.classList.remove("show");
          }, 2000);
        }

        // --- VIEW MANAGEMENT ---
        function showView(viewId) {
          Object.keys(activeCharts).forEach((key) => {
            if (activeCharts[key]) {
              activeCharts[key].destroy();
              delete activeCharts[key];
            }
          });

          Object.values(views).forEach((view) => view.classList.add("hidden"));
          views[viewId].classList.remove("hidden");
          currentView = viewId;
          window.scrollTo(0, 0);

          navButtons.forEach((btn) => {
            const view = btn.getAttribute("data-view");
            if (view === viewId) {
              btn.classList.remove("text-gray-400");
              btn.classList.add("text-neon");
            } else {
              btn.classList.add("text-gray-400");
              btn.classList.remove("text-neon");
            }
          });

          if (
            [
              "routineDetailView",
              "exerciseLoggingView",
              "exerciseHistoryView",
            ].includes(viewId)
          ) {
            const routinesBtn = document.querySelector(
              '.nav-btn[data-view="routinesView"]'
            );
            if (routinesBtn) {
              routinesBtn.classList.remove("text-gray-400");
              routinesBtn.classList.add("text-neon");
            }
          }

          if (viewId === "routinesView") renderRoutineList();
          if (viewId === "bodyWeightView") renderBodyWeightHistory();
          if (viewId === "globalHistoryView") renderGlobalHistory();
        }

        // --- RENDER FUNCTIONS ---
        function renderRoutineList() {
          routineList.innerHTML = "";
          const routines = Object.keys(db.routines).sort();
          if (routines.length === 0) {
            routineList.innerHTML = `<p class="text-gray-500 text-center">No routines added yet. Add one above!</p>`;
            return;
          }
          routines.forEach((routine) => {
            const el = document.createElement("div");
            el.className =
              "card p-5 flex justify-between items-center cursor-pointer hover:bg-[#2A2A2A]";
            el.setAttribute("data-routine", routine);
            el.innerHTML = `
              <span class="text-lg font-medium text-white">${routine}</span>
              <span class="text-xl text-neon font-bold">&rarr;</span>
            `;
            el.addEventListener("click", () => {
              currentRoutine = routine;
              currentRoutineName.textContent = routine;
              showView("routineDetailView");
              renderRoutineExercises(routine);
            });
            routineList.appendChild(el);
          });
        }

        function renderRoutineExercises(routineName) {
          routineExerciseList.innerHTML = "";
          const exercises = db.routines[routineName]
            ? Object.keys(db.routines[routineName]).sort()
            : [];
          if (exercises.length === 0) {
            routineExerciseList.innerHTML = `<p class="text-gray-500 text-center">No exercises in this routine yet. Add one above!</p>`;
            return;
          }
          exercises.forEach((exercise) => {
            const el = document.createElement("div");
            el.className =
              "card p-4 flex justify-between items-center cursor-pointer hover:bg-[#2A2A2A]";
            el.setAttribute("data-exercise", exercise);
            el.innerHTML = `
              <span class="text-lg font-medium text-white">${exercise}</span>
              <span class="text-xl text-neon font-bold">&rarr;</span>
            `;
            el.addEventListener("click", () => {
              currentExerciseInRoutine = exercise;
              loggingExerciseName.textContent = exercise;
              currentSets = [];
              renderCurrentSets();
              lastWorkoutInfo.textContent = formatLastWorkout(
                currentRoutine,
                currentExerciseInRoutine
              );
              showView("exerciseLoggingView");
            });
            routineExerciseList.appendChild(el);
          });
        }

        function renderCurrentSets() {
          currentSetsList.innerHTML = "";
          if (currentSets.length === 0) {
            currentSetsList.innerHTML = `<p class="text-gray-500 text-center text-sm">Add your first set above.</p>`;
            return;
          }
          [...currentSets].reverse().forEach((set, index) => {
            const reversedIndex = currentSets.length - 1 - index;
            const el = document.createElement("li");
            el.className =
              "card p-3 flex justify-between items-center animate-fade-in";
            el.innerHTML = `
              <span class="font-medium text-white">
                Set ${reversedIndex + 1}: ${set.reps} reps @ ${formatWeight(
              set.weight
            )}
              </span>
              <button class="remove-set-btn text-sm text-red-500 hover:text-red-400 font-medium px-2" data-index="${reversedIndex}">
                Remove
              </button>
            `;
            el.querySelector(".remove-set-btn").addEventListener(
              "click",
              () => {
                currentSets.splice(reversedIndex, 1);
                renderCurrentSets();
              }
            );
            currentSetsList.appendChild(el);
          });
        }

        function renderExerciseHistory(routineName, exerciseName) {
          fullExerciseHistoryList.innerHTML = "";
          const history =
            db.routines[routineName] && db.routines[routineName][exerciseName]
              ? db.routines[routineName][exerciseName]
              : [];
          if (history.length === 0) {
            fullExerciseHistoryList.innerHTML = `<p class="text-gray-500 text-center">No history for this exercise.</p>`;
            return;
          }
          history
            .slice()
            .reverse()
            .forEach((workout) => {
              const el = document.createElement("div");
              el.className = "card p-4";
              let setsHtml = workout.sets
                .map(
                  (set, index) => `
              <li class="flex justify-between text-gray-200">
                <span>Set ${index + 1}</span>
                <span class="font-medium">${set.reps} reps @ ${formatWeight(
                    set.weight
                  )}</span>
              </li>
            `
                )
                .join("");

              el.innerHTML = `
              <h4 class="text-lg font-semibold text-neon mb-2">${formatDateDisplay(
                workout.date
              )}</h4>
              <ul class="space-y-2">${setsHtml}</ul>
            `;
              fullExerciseHistoryList.appendChild(el);
            });
        }

        function renderBodyWeightHistory() {
          bodyweightHistoryList.innerHTML = "";
          const history = db.bodyWeight || [];
          if (history.length === 0) {
            bodyweightHistoryList.innerHTML = `<p class="text-gray-500 text-center">No body weight logged yet.</p>`;
          } else {
            history
              .slice()
              .reverse()
              .forEach((entry) => {
                const el = document.createElement("div");
                el.className = "card p-3 flex justify-between items-center";
                el.innerHTML = `
                <span class="text-gray-300">${formatDateDisplay(
                  entry.date
                )}</span>
                <span class="font-medium text-white">${formatWeight(
                  entry.weight
                )}</span>
              `;
                bodyweightHistoryList.appendChild(el);
              });
          }
          updateBodyWeightChart();
        }

        function updateBodyWeightChart() {
          const history = db.bodyWeight || [];
          if (activeCharts.bodyWeight) activeCharts.bodyWeight.destroy();

          const ctx = bodyweightChartCanvas;
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clear canvas

          if (history.length === 0) {
            ctx.fillStyle = "#6b7280"; // gray-500
            ctx.textAlign = "center";
            ctx.font = "16px Inter";
            ctx.fillText(
              "No data to display",
              ctx.canvas.width / 2,
              ctx.canvas.height / 2
            );
            return;
          }

          const sortedHistory = [...history].sort(
            (a, b) => new Date(a.date) - new Date(b.date)
          );
          const labels = sortedHistory.map((entry) =>
            formatDateDisplay(entry.date)
          );
          const data = sortedHistory.map((entry) => {
            return parseFloat(
              formatWeight(entry.weight, unitPreference).split(" ")[0]
            );
          });

          activeCharts.bodyWeight = new Chart(ctx, {
            // Use ctx
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: `Body Weight (${unitPreference})`,
                  data: data,
                  borderColor: neonColor,
                  backgroundColor: "rgba(175, 255, 12, 0.1)",
                  tension: 0.3,
                  pointBackgroundColor: neonColor,
                  pointBorderColor: "#ffffff",
                  pointBorderWidth: 2,
                  pointRadius: 5, // CHANGED: Made dots slightly larger
                  pointHoverRadius: 7, // CHANGED: Made dots larger on hover
                  fill: true,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: "#1A1A1A",
                  titleColor: textColor,
                  bodyColor: textColor,
                  borderColor: gridColor,
                  borderWidth: 1,
                },
              },
              scales: {
                x: { grid: { color: gridColor }, ticks: { color: textColor } },
                y: { grid: { color: gridColor }, ticks: { color: textColor } },
              },
            },
          });
        }

        function renderGlobalHistory() {
          globalWorkoutHistoryList.innerHTML = "";
          let allWorkouts = [];
          Object.keys(db.routines).forEach((routine) => {
            if (!db.routines[routine]) return; // Safeguard
            Object.keys(db.routines[routine]).forEach((exercise) => {
              if (!db.routines[routine][exercise]) return; // Safeguard
              db.routines[routine][exercise].forEach((workout) => {
                allWorkouts.push({ routine, exercise, ...workout });
              });
            });
          });
          allWorkouts.sort((a, b) => new Date(b.date) - new Date(a.date));

          if (allWorkouts.length === 0) {
            globalWorkoutHistoryList.innerHTML = `<p class="text-gray-500 text-center">No workouts recorded yet.</p>`;
          } else {
            const groupedByDate = {};
            allWorkouts.forEach((workout) => {
              if (!groupedByDate[workout.date])
                groupedByDate[workout.date] = [];
              groupedByDate[workout.date].push(workout);
            });

            Object.keys(groupedByDate)
              .sort()
              .reverse()
              .forEach((date) => {
                const dateEl = document.createElement("div");
                dateEl.className = "card p-4";
                dateEl.innerHTML = `<h3 class="text-lg font-semibold text-neon mb-3">${formatDateDisplay(
                  date
                )}</h3>`;

                const workoutsByRoutine = {};
                groupedByDate[date].forEach((workout) => {
                  if (!workoutsByRoutine[workout.routine])
                    workoutsByRoutine[workout.routine] = [];
                  workoutsByRoutine[workout.routine].push(workout);
                });

                Object.keys(workoutsByRoutine).forEach((routine) => {
                  let routineHtml = `<div class="mb-3 last:mb-0">
                  <h4 class="font-semibold text-white mb-2">${routine}</h4>`;

                  workoutsByRoutine[routine].forEach((workout) => {
                    let setsHtml = workout.sets
                      .map(
                        (set, index) => `
                    <li class="flex justify-between text-sm text-gray-300">
                      <span>Set ${index + 1}: ${set.reps} reps</span>
                      <span class="font-medium text-gray-100">${formatWeight(
                        set.weight
                      )}</span>
                    </li>`
                      )
                      .join("");

                    routineHtml += `
                    <div class="ml-4 mb-2">
                      <h5 class="font-medium text-gray-200">${workout.exercise}</h5>
                      <ul class="ml-4 space-y-1 mt-1">${setsHtml}</ul>
                    </div>`;
                  });
                  routineHtml += `</div>`;
                  dateEl.innerHTML += routineHtml;
                });
                globalWorkoutHistoryList.appendChild(dateEl);
              });
          }

          updateTotalVolumeChart(allWorkouts);
        }

        function updateTotalVolumeChart(allWorkouts) {
          if (activeCharts.totalVolume) activeCharts.totalVolume.destroy();

          const volumeByDate = {};
          allWorkouts.forEach((workout) => {
            const dayVolume = workout.sets.reduce(
              (total, set) => total + set.weight * set.reps,
              0
            );
            if (volumeByDate[workout.date]) {
              volumeByDate[workout.date] += dayVolume;
            } else {
              volumeByDate[workout.date] = dayVolume;
            }
          });

          const sortedDates = Object.keys(volumeByDate).sort(
            (a, b) => new Date(a) - new Date(b)
          );

          const ctx = totalVolumeChartCanvas;
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clear canvas

          if (sortedDates.length === 0) {
            ctx.fillStyle = "#6b7280"; // gray-500
            ctx.textAlign = "center";
            ctx.font = "16px Inter";
            ctx.fillText(
              "No data to display",
              ctx.canvas.width / 2,
              ctx.canvas.height / 2
            );
            return;
          }

          const labels = sortedDates.map((date) => formatDateDisplay(date));
          const data = sortedDates.map((date) => volumeByDate[date]);

          activeCharts.totalVolume = new Chart(ctx, {
            // Use ctx
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Total Volume (kg)",
                  data: data,
                  backgroundColor: neonColor,
                  borderRadius: 4,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: "#1A1A1A",
                  callbacks: {
                    label: (context) => `${context.parsed.y.toFixed(0)} kg`,
                  },
                },
              },
              scales: {
                x: { grid: { display: false }, ticks: { color: textColor } },
                y: {
                  grid: { color: gridColor },
                  ticks: { color: textColor },
                  beginAtZero: true,
                },
              },
            },
          });
        }

        // --- EVENT LISTENERS ---
        // Tab Navigation
        navButtons.forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const viewId = e.currentTarget.dataset.view;
            if (viewId) showView(viewId);
          });
        });

        // Profile
        unitToggleKg.addEventListener("click", () =>
          updateUnitPreference("kg")
        );
        unitToggleLbs.addEventListener("click", () =>
          updateUnitPreference("lbs")
        );

        updateNameForm.addEventListener("submit", (e) => {
          // NEW
          e.preventDefault();
          const newName = toTitleCase(usernameInput.value.trim());
          if (newName) {
            userName = newName;
            saveData();
            updateUserNameDisplay();
            showMessage("Name updated!", false);
          } else {
            showMessage("Please enter a valid name.", true);
          }
        });

        clearAllBtn.addEventListener("click", () => {
          showModal(
            "Clear All Data?",
            "This will delete all routines, exercises, and history. This action cannot be undone.",
            () => {
              db = { routines: {}, bodyWeight: [] };
              // Keep user name
              saveData();
              showView("routinesView");
              hideModal();
              showMessage("All data cleared.", false);
            }
          );
        });

        // Add Routine
        addRoutineForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const routineName = toTitleCase(newRoutineInput.value.trim());
          if (!routineName) return;
          if (db.routines[routineName]) {
            showMessage("A routine with this name already exists.", true);
            return;
          }
          db.routines[routineName] = {};
          saveData();
          newRoutineInput.value = "";
          renderRoutineList();
          showMessage(`Routine "${routineName}" added!`, false);
        });

        // Add Exercise to Routine
        addExerciseToRoutineForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const exerciseName = toTitleCase(newRoutineExerciseName.value.trim());
          if (!exerciseName) return;
          if (!db.routines[currentRoutine]) db.routines[currentRoutine] = {};
          if (db.routines[currentRoutine][exerciseName]) {
            showMessage("This exercise already exists in this routine.", true);
            return;
          }
          db.routines[currentRoutine][exerciseName] = [];
          saveData();
          newRoutineExerciseName.value = "";
          renderRoutineExercises(currentRoutine);
          showMessage(`Exercise "${exerciseName}" added!`, false);
        });

        // Delete Routine
        deleteRoutineBtn.addEventListener("click", () => {
          if (!currentRoutine) return;
          showModal(
            "Delete Routine?",
            `Delete "${currentRoutine}" and all its history?`,
            () => {
              delete db.routines[currentRoutine];
              saveData();
              showView("routinesView");
              hideModal();
              showMessage(`Routine "${currentRoutine}" deleted.`, false);
            }
          );
        });

        // Delete Exercise
        deleteExerciseFromRoutineBtn.addEventListener("click", () => {
          if (!currentRoutine || !currentExerciseInRoutine) return;
          showModal(
            "Delete Exercise?",
            `Delete "${currentExerciseInRoutine}" and all its history from this routine?`,
            () => {
              delete db.routines[currentRoutine][currentExerciseInRoutine];
              saveData();
              renderRoutineExercises(currentRoutine);
              showView("routineDetailView");
              hideModal();
              showMessage(
                `Exercise "${currentExerciseInRoutine}" deleted.`,
                false
              );
            }
          );
        });

        // Add Set
        addSetForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const reps = parseInt(repsInput.value);
          let weight = parseFloat(weightInput.value);

          if (!reps || reps <= 0) {
            showMessage("Please enter valid reps.", true);
            repsInput.focus();
            return;
          }
          if (isNaN(weight) || weight < 0) {
            weight = 0;
          }

          let weightToStore =
            unitPreference === "lbs"
              ? convertWeight(weight, "lbs", "kg")
              : weight;
          currentSets.push({ reps, weight: weightToStore });
          renderCurrentSets();
          repsInput.value = "";
          repsInput.focus();
        });

        // Save Workout
        saveWorkoutBtn.addEventListener("click", () => {
          if (currentSets.length === 0) {
            showMessage("No sets to save. Add some sets first.", true);
            return;
          }
          if (!db.routines[currentRoutine]) db.routines[currentRoutine] = {};
          if (!db.routines[currentRoutine][currentExerciseInRoutine]) {
            db.routines[currentRoutine][currentExerciseInRoutine] = [];
          }

          const today = getTodayDate();
          const existingWorkoutIndex = db.routines[currentRoutine][
            currentExerciseInRoutine
          ].findIndex((w) => w.date === today);

          if (existingWorkoutIndex !== -1) {
            db.routines[currentRoutine][currentExerciseInRoutine][
              existingWorkoutIndex
            ].sets.push(...currentSets);
          } else {
            db.routines[currentRoutine][currentExerciseInRoutine].push({
              date: today,
              sets: [...currentSets],
            });
          }
          saveData();
          currentSets = [];
          renderCurrentSets();
          lastWorkoutInfo.textContent = formatLastWorkout(
            currentRoutine,
            currentExerciseInRoutine
          );
          showMessage("Workout saved successfully!", false);
        });

        // Add Body Weight
        addBodyweightForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const weight = parseFloat(bodyweightInput.value);
          if (!weight || weight <= 0) {
            showMessage("Please enter a valid weight.", true);
            return;
          }
          let weightToStore =
            unitPreference === "lbs"
              ? convertWeight(weight, "lbs", "kg")
              : weight;
          const today = getTodayDate();
          const existingEntryIndex = db.bodyWeight.findIndex(
            (entry) => entry.date === today
          );

          if (existingEntryIndex !== -1) {
            db.bodyWeight[existingEntryIndex].weight = weightToStore;
          } else {
            db.bodyWeight.push({ date: today, weight: weightToStore });
          }
          db.bodyWeight.sort((a, b) => new Date(a.date) - new Date(b.date));

          saveData();
          bodyweightInput.value = "";
          renderBodyWeightHistory();
          showMessage("Body weight logged!", false);
        });

        // Back Buttons
        routineDetailBackBtn.addEventListener("click", () =>
          showView("routinesView")
        );
        exerciseLoggingBackBtn.addEventListener("click", () => {
          if (currentSets.length > 0) {
            showModal(
              "Unsaved Sets",
              "You have unsaved sets. Are you sure you want to go back? They will be lost.",
              () => {
                currentSets = [];
                showView("routineDetailView");
                hideModal();
              }
            );
          } else {
            showView("routineDetailView");
          }
        });
        exerciseHistoryBackBtn.addEventListener("click", () =>
          showView("exerciseLoggingView")
        );

        // Show Exercise History
        showExerciseHistoryBtn.addEventListener("click", () => {
          historyExerciseName.textContent = currentExerciseInRoutine;
          renderExerciseHistory(currentRoutine, currentExerciseInRoutine);
          showView("exerciseHistoryView");
        });

        // Modal Listeners
        modalCancelBtn.addEventListener("click", hideModal);
        modalConfirmBtn.addEventListener("click", () => {
          if (modalConfirmCallback) modalConfirmCallback();
        });
        modal.addEventListener("click", (e) => {
          if (e.target === modal) hideModal();
        });

        // --- INITIALIZATION ---

        function initializeApp() {
          loadData(); // Load all data
          updateUnitPreference(unitPreference);
          updateUserNameDisplay();
          showView("routinesView"); // Start on the main routines view
        }

        function checkUserName() {
          loadData(); // Load just to get name
          if (userName) {
            initializeApp();
          } else {
            welcomeModal.classList.remove("hidden");
            welcomeModal.classList.add("flex");
          }
        }

        welcomeForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const newName = toTitleCase(nameInput.value.trim());
          if (newName) {
            userName = newName;
            saveData(); // Save the new name
            welcomeModal.classList.add("hidden");
            welcomeModal.classList.remove("flex");
            initializeApp(); // Run the full app initialization
          } else {
            // Show a simple error inside the modal
            nameInput.placeholder = "Please enter a valid name!";
            nameInput.classList.add("border-red-500");
          }
        });

        checkUserName(); // Run the app start logic
      });
    </script>
  </body>
</html>
